{% extends 'base.html' %}
{% load static %}

{% block title %}{{ property.title }} - VeriHome{% endblock %}

{% block content %}

<!-- Mensajes -->
{% if messages %}
<div class="container mx-auto px-4 py-4">
    {% for message in messages %}
    <div class="rounded-lg p-4 mb-4 {% if message.tags == 'success' %}bg-green-50 text-green-800{% else %}bg-red-50 text-red-800{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Encabezado -->
<div class="pt-24 pb-12 bg-gradient-to-r from-primary to-amber-400">
    <div class="container mx-auto px-4">
        <h1 class="montserrat text-4xl font-bold text-white text-center">{{ property.title }}</h1>
        <p class="text-white text-center mt-4 max-w-2xl mx-auto">Detalles completos de esta propiedad en nuestra comunidad inmobiliaria confiable.</p>
    </div>
</div>

<!-- Contenido principal -->
<div class="container mx-auto px-4 py-16">
    <div class="bg-white rounded-lg shadow-xl p-8 space-y-12">

        <!-- Galería de Fotos -->
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Galería de Fotos</h2>
            {% if property.related_photos.all %}
            <div id="gallery" class="relative">
                <div class="main-image mb-4">
                    <img id="currentImage" src="{{ property.related_photos.all.0.image.url }}" alt="Foto de {{ property.title }}" class="w-full h-96 object-cover rounded-lg cursor-zoom-in transition-transform duration-300" />
                </div>
                <div class="flex space-x-4 overflow-x-auto">
                    {% for photo in property.related_photos.all %}
                    <img src="{{ photo.image.url }}" alt="Miniatura de {{ property.title }}" class="w-20 h-20 object-cover rounded-lg cursor-pointer border-2 border-transparent hover:border-amber-500 transition-all duration-300" onclick="changeImage(this)" />
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <p class="text-gray-700">No hay fotos disponibles.</p>
            {% endif %}
        </section>

        <!-- Video de la propiedad -->
        {% if property.video %}
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Video de la Propiedad</h2>
            <video controls class="w-full rounded-lg max-h-96">
                <source src="{{ property.video.url }}" type="video/mp4" />
                Tu navegador no soporta la reproducción de video.
            </video>
        </section>
        {% elif property.video_url %}
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Video de la Propiedad</h2>
            {% if "youtube.com" in property.video_url or "youtu.be" in property.video_url %}
                {% if "watch?v=" in property.video_url %}
                    {% with property.video_url|slice:"https://www.youtube.com/watch?v=" as video_id %}
                    <div class="relative w-full" style="padding-bottom: 56.25%;">
                        <iframe class="absolute top-0 left-0 w-full h-full rounded-lg"
                            src="https://www.youtube.com/embed/{{ video_id }}?rel=0"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                    {% endwith %}
                {% elif "youtu.be" in property.video_url %}
                    {% with video_id=property.video_url|cut:"https://youtu.be/" %}
                    <div class="relative w-full" style="padding-bottom: 56.25%;">
                        <iframe class="absolute top-0 left-0 w-full h-full rounded-lg"
                            src="https://www.youtube.com/embed/{{ video_id }}?rel=0"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                    {% endwith %}
                {% else %}
                <p class="text-gray-700">El enlace de YouTube no es válido. Use un formato adecuado.</p>
                {% endif %}
            {% elif "vimeo.com" in property.video_url %}
            <div class="relative w-full" style="padding-bottom: 56.25%;">
                <iframe class="absolute top-0 left-0 w-full h-full rounded-lg"
                    src="{{ property.video_url }}"
                    frameborder="0"
                    allow="autoplay; fullscreen; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
            {% else %}
            <p class="text-gray-700">El enlace del video no es compatible. Use YouTube o Vimeo.</p>
            {% endif %}
        </section>
        {% endif %}

        <!-- Información básica -->
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Detalles de la Propiedad</h2>
            <ul class="space-y-2 text-gray-800">
                <li><strong>Precio:</strong> {{ property.price|floatformat:0 }} {{ property.price_type }}</li>
                <li><strong>Tipo de propiedad:</strong> {{ property.property_type }}</li>
                <li><strong>Estado:</strong> {{ property.property_status }}</li>
                <li><strong>Área construida:</strong> {{ property.construction_area }} m²</li>
                <li><strong>Área total:</strong> {{ property.land_area }} m²</li>
                <li><strong>Habitaciones:</strong> {{ property.bedrooms }}</li>
                <li><strong>Baños:</strong> {{ property.bathrooms }}</li>
                <li><strong>Parqueaderos:</strong> {{ property.parking_spaces }}</li>
                <li><strong>Dirección exacta:</strong> {{ property.exact_address }}</li>
            </ul>
        </section>

        <!-- Mapa -->
        {% if property.exact_address %}
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Ubicación en el mapa</h2>
            <div class="relative w-full h-96 rounded-lg overflow-hidden">
                <iframe
                    class="w-full h-full"
                    src="https://www.google.com/maps/embed/v1/place?key={{ GOOGLE_MAPS_API_KEY }}&q={{ property.exact_address|urlencode }}"
                    allowfullscreen
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade">
                </iframe>
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- Botón WhatsApp -->
<a href="https://wa.me/1234567890?text=Hola,%20quiero%20información%20sobre%20la%20propiedad:%20{{ property.title|urlencode }}"
    target="_blank"
    class="whatsapp-btn fixed bottom-6 right-6 w-16 h-16 flex items-center justify-center bg-[#22C55E] text-white rounded-full shadow-lg z-50">
    <i class="ri-whatsapp-line ri-2x"></i>
</a>

<!-- Scripts -->
<script>
    function changeImage(element) {
        const mainImage = document.getElementById('currentImage');
        mainImage.src = element.src;
    }

    document.getElementById('currentImage').addEventListener('click', function () {
        const image = this;
        const zoomIn = image.classList.contains('cursor-zoom-in');
        image.classList.toggle('cursor-zoom-in', !zoomIn);
        image.classList.toggle('cursor-zoom-out', zoomIn);
        image.style.transform = zoomIn ? 'scale(2)' : 'scale(1)';
    });
</script>

<style>
    #currentImage.cursor-zoom-in {
        cursor: zoom-in;
    }
    #currentImage.cursor-zoom-out {
        cursor: zoom-out;
    }
</style>

{% endblock %}