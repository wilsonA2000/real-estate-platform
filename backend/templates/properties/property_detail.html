{% extends 'base.html' %}
{% load static %}

{% block title %}{{ property.title }} - VeriHome{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" />
<style>
    .property-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .gallery-item {
        position: relative;
        height: 200px;
        overflow: hidden;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        cursor: pointer;
    }
    .gallery-item:hover {
        transform: scale(1.03);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .gallery-item:focus {
        outline: 3px solid #F59E0B;
        transform: scale(1.03);
    }
    .gallery-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .modern-video-frame {
        background: linear-gradient(135deg, #f3f4f6 0%, #e0e7ff 100%);
        border-radius: 24px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.18);
        border: 2.5px solid #e5e7eb;
        padding: 2.5rem 2rem 2rem 2rem;
        margin: 2.5rem auto 0 auto;
        max-width: 980px;
        min-width: 340px;
        transition: box-shadow 0.3s;
        position: relative;
        animation: fadeIn 0.7s cubic-bezier(.4,0,.2,1);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .modern-video-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        font-family: 'Montserrat', sans-serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        letter-spacing: 0.01em;
    }
    .modern-video-header i {
        font-size: 2rem;
        color: #6366f1;
        vertical-align: middle;
    }
    .modern-video-preview {
        width: 900px;
        height: 506px;
        max-width: 100%;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        background: #18181b;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1.5px solid #c7d2fe;
        margin: 0 auto;
        position: relative;
    }
    .modern-video-preview .plyr,
    .modern-video-preview iframe,
    .modern-video-preview video {
        border-radius: 18px !important;
        width: 100% !important;
        height: 100% !important;
        min-width: 320px;
        min-height: 180px;
        max-width: 100%;
        max-height: 100%;
        background: #18181b;
        display: block;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .property-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .detail-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .detail-icon {
        color: #F59E0B;
        margin-right: 0.75rem;
        font-size: 1.25rem;
    }
    .map-container {
        position: relative;
        height: 400px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    /* Estilos para evitar problemas de renderizado del mapa */
    #mapbox-detail-map {
        width: 100%;
        height: 100%;
        min-height: 350px;
        border-radius: 8px;
        background-color: #e9eef2;
        position: relative;
        overflow: hidden;
    }
    .mapboxgl-canvas {
        left: 0;
        width: 100% !important;
        height: 100% !important;
    }
    .mapboxgl-marker {
        cursor: pointer;
    }
    .mapboxgl-popup {
        max-width: 300px;
    }
    .mapboxgl-popup-content {
        padding: 12px;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    /* Estilos para la dirección */
    .property-address {
        margin-bottom: 0.75rem;
        line-height: 1.5;
        color: #4b5563;
    }
    .property-address strong {
        color: #1f2937;
    }
    .contact-form-container {
        background-color: #f9fafb;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 2rem;
    }
    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        min-width: 180px;
        font-size: 16px;
        font-family: 'Roboto', sans-serif;
    }
    .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .action-button i {
        margin-right: 0.5rem;
        font-size: 1.25rem;
    }
    .edit-button {
        background-color: #F59E0B;
        color: white;
    }
    .edit-button:hover {
        background-color: #D97706;
    }
    .delete-button {
        background-color: #EF4444;
        color: white;
    }
    .delete-button:hover {
        background-color: #DC2626;
    }
    /* Estilos para el modal de confirmación */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }
    .modal-container {
        background-color: #1F2937;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 500px;
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    .modal-icon {
        background-color: rgba(239, 68, 68, 0.1);
        color: #EF4444;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        font-size: 1.5rem;
    }
    .modal-title {
        color: white;
        font-size: 1.25rem;
        font-weight: 600;
    }
    .modal-body {
        color: #D1D5DB;
        margin-bottom: 1.5rem;
    }
    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }
    .modal-button {
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
    }
    .modal-cancel {
        background-color: #374151;
        color: white;
    }
    .modal-cancel:hover {
        background-color: #4B5563;
    }
    .modal-confirm {
        background-color: #EF4444;
        color: white;
    }
    .modal-confirm:hover {
        background-color: #DC2626;
    }
</style>
{% endblock %}

{% block content %}
<!-- Mensajes -->
{% if messages %}
<div class="container mx-auto px-4 py-4">
    {% for message in messages %}
    <div class="rounded-lg p-4 mb-4 {% if message.tags == 'success' %}bg-green-50 text-green-800{% elif message.tags == 'success safe' %}bg-green-50 text-green-800{% elif message.tags == 'warning' %}bg-yellow-50 text-yellow-800{% else %}bg-red-50 text-red-800{% endif %}">
        {% if 'safe' in message.tags %}
            {{ message|safe }}
        {% else %}
            {{ message }}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Encabezado -->
<div class="pt-24 pb-12 bg-gradient-to-r from-primary to-amber-400">
    <div class="container mx-auto px-4">
        <h1 class="montserrat text-4xl font-bold text-white text-center">{{ property.title }}</h1>
        <p class="text-white text-center mt-4 max-w-2xl mx-auto">Detalles completos de esta propiedad en nuestra comunidad inmobiliaria confiable.</p>
    </div>
</div>

<!-- Resto del contenido (se mantiene igual) -->
<div class="container mx-auto px-4 py-16">
    <div class="bg-white rounded-lg shadow-xl p-8 space-y-12">
        <!-- Galería de Fotos con Lightbox -->
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Galería de Fotos</h2>
            {% if photos %}
            <div class="property-gallery">
                {% for photo in photos %}
                <div class="gallery-item" onclick="openImageModal('{{ photo.image.url }}')" tabindex="0" onkeydown="if(event.key === 'Enter') openImageModal('{{ photo.image.url }}')">
                    <img src="{{ photo.image.url }}" alt="Foto de {{ property.title }}" class="gallery-image">
                </div>
                {% empty %}
                <p class="text-gray-700">No hay fotos disponibles.</p>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-700">No hay fotos disponibles.</p>
            {% endif %}
        </section>

        <!-- Video -->
        <section>
            <div class="modern-video-frame">
                <div class="modern-video-header">
                    <i class="ri-movie-2-line"></i>
                    <span>Video de la Propiedad</span>
                </div>
                <div class="modern-video-preview">
                    {% if property.video %}
                        <video id="property-video" playsinline controls data-poster="{% if property.main_photo %}{{ property.main_photo.url }}{% endif %}" style="width:100%;max-width:900px;display:block;margin:auto;">
                            <source src="{{ property.video.url }}" type="video/mp4" />
                            Tu navegador no soporta la reproducción de video.
                        </video>
                    {% elif property.video_url %}
                        {% if "youtube.com" in property.video_url or "youtu.be" in property.video_url %}
                            {% if "watch?v=" in property.video_url %}
                                {% with video_id=property.video_url|cut:"https://www.youtube.com/watch?v=" %}
                                <div class="plyr__video-embed" style="width:100%;height:100%;">
                                    <iframe
                                        src="https://www.youtube.com/embed/{{ video_id|cut:'&' }}?origin=https://plyr.io&amp;iv_load_policy=3&amp;modestbranding=1&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;enablejsapi=1"
                                        allowfullscreen
                                        allowtransparency
                                        allow="autoplay"
                                    ></iframe>
                                </div>
                                {% endwith %}
                            {% elif "youtu.be" in property.video_url %}
                                {% with video_id=property.video_url|cut:"https://youtu.be/" %}
                                <div class="plyr__video-embed" style="width:100%;height:100%;">
                                    <iframe
                                        src="https://www.youtube.com/embed/{{ video_id|cut:'?' }}?origin=https://plyr.io&amp;iv_load_policy=3&amp;modestbranding=1&amp;playsinline=1&amp;showinfo=0&amp;rel=0&amp;enablejsapi=1"
                                        allowfullscreen
                                        allowtransparency
                                        allow="autoplay"
                                    ></iframe>
                                </div>
                                {% endwith %}
                            {% else %}
                            <p class="text-gray-700">El enlace de YouTube no es válido. Use un formato adecuado.</p>
                            {% endif %}
                        {% elif "vimeo.com" in property.video_url %}
                            {% with video_id=property.video_url|cut:"https://vimeo.com/" %}
                            <div class="plyr__video-embed" style="width:100%;height:100%;">
                                <iframe
                                    src="https://player.vimeo.com/video/{{ video_id|cut:'?' }}?loop=false&amp;byline=false&amp;portrait=false&amp;title=false&amp;speed=true&amp;transparent=0&amp;gesture=media"
                                    allowfullscreen
                                    allowtransparency
                                    allow="autoplay"
                                ></iframe>
                            </div>
                            {% endwith %}
                        {% else %}
                        <p class="text-gray-700">El enlace del video no es compatible. Use YouTube o Vimeo.</p>
                        {% endif %}
                    {% else %}
                        <div class="flex flex-col items-center justify-center py-8">
                            <i class="ri-movie-line text-5xl text-gray-300 mb-2"></i>
                            <p class="text-gray-500">No hay video disponible para esta propiedad.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Información básica -->
        <section class="bg-gray-50 p-6 rounded-lg shadow-sm">
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Detalles de la Propiedad</h2>
            <div class="property-details-grid">
                <div>
                    <ul class="space-y-3 text-gray-800">
                        <li class="detail-item"><i class="ri-money-dollar-circle-line detail-icon"></i><strong class="mr-2">Precio:</strong> {{ property.price|floatformat:0 }} {{ property.currency }}</li>
                        <li class="detail-item"><i class="ri-home-4-line detail-icon"></i><strong class="mr-2">Tipo de propiedad:</strong> {{ property.get_property_type_display }}</li>
                        <li class="detail-item"><i class="ri-building-line detail-icon"></i><strong class="mr-2">Área construida:</strong> {{ property.construction_area|default:"No especificada" }} m²</li>
                        <li class="detail-item"><i class="ri-landscape-line detail-icon"></i><strong class="mr-2">Área total:</strong> {{ property.land_area|default:"No especificada" }} m²</li>
                        <li class="detail-item"><i class="ri-map-pin-line detail-icon"></i><strong class="mr-2">Ubicación:</strong> {{ property.location }}</li>
                    </ul>
                </div>
                <div>
                    <ul class="space-y-3 text-gray-800">
                        <li class="detail-item"><i class="ri-hotel-bed-line detail-icon"></i><strong class="mr-2">Habitaciones:</strong> {{ property.bedrooms|default:"No especificado" }}</li>
                        <li class="detail-item"><i class="ri-shower-line detail-icon"></i><strong class="mr-2">Baños:</strong> {{ property.bathrooms|default:"No especificado" }}</li>
                        <li class="detail-item"><i class="ri-parking-box-line detail-icon"></i><strong class="mr-2">Parqueaderos:</strong> {{ property.parking_spaces|default:"No especificado" }}</li>
                        <li class="detail-item"><i class="ri-calendar-line detail-icon"></i><strong class="mr-2">Publicado:</strong> {{ property.created_at|date:"d/m/Y" }}</li>
                        <li class="detail-item"><i class="ri-user-line detail-icon"></i><strong class="mr-2">Propietario:</strong> {{ property.owner.name|default_if_none:"No especificado" }}</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Descripción -->
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Descripción</h2>
            <div class="prose max-w-none text-gray-700">
                <p>{{ property.description|linebreaks }}</p>
            </div>
        </section>

        <!-- Características -->
        {% if property.characteristics %}
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Características</h2>
            <div class="prose max-w-none text-gray-700">
                <p>{{ property.characteristics|linebreaks }}</p>
            </div>
        </section>
        {% endif %}

        <!-- Requisitos -->
        {% if property.requirements %}
        <section>
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Requisitos</h2>
            <div class="prose max-w-none text-gray-700">
                <p>{{ property.requirements|linebreaks }}</p>
            </div>
        </section>
        {% endif %}

        <!-- Mapa usando Mapbox -->
        {% if property.latitude and property.longitude %}
        <section class="mt-12">
            <h2 class="montserrat text-2xl font-bold mb-4 text-gray-900">Ubicación exacta</h2>
            {% if property.exact_address %}
            <p class="text-gray-700 mb-4"><strong>Dirección:</strong> {{ property.exact_address }}</p>
            {% endif %}
            <div class="container mx-auto pb-4 map-container">
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div id="mapbox-detail-map" 
                         data-lat="{{ property.latitude }}" 
                         data-lng="{{ property.longitude }}" 
                         {% if property.exact_address %}data-address="{{ property.exact_address }}"{% endif %}
                         style="height: 350px; border-radius: 8px;">
                    </div>
                </div>
            </div>
        </section>
        {% endif %}
        
        <!-- Botones de acción para el propietario -->
        {% if user == property.owner %}
        <section>
            <div class="action-buttons">
                <a href="{% url 'property_edit' property.id %}" class="action-button edit-button">
                    <i class="ri-edit-line"></i> Editar propiedad
                </a>
                <a href="#" id="delete-property-btn" class="action-button delete-button">
                    <i class="ri-delete-bin-line"></i> Eliminar propiedad
                </a>
            </div>
        </section>
        {% endif %}
    </div>
</div>

<!-- Modal de confirmación para eliminar propiedad -->
<form id="delete-form" method="POST" action="{% url 'property_delete' property.id %}">
    {% csrf_token %}
    <div id="delete-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:9999;">
        <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background-color:#1F2937; padding:20px; border-radius:10px; width:90%; max-width:500px;">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <div style="background-color:rgba(239,68,68,0.1); color:#EF4444; width:48px; height:48px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                    <i class="ri-error-warning-line" style="font-size:24px;"></i>
                </div>
                <h3 style="color:white; font-size:20px; font-weight:600;">Confirmar eliminación</h3>
            </div>
            <div style="color:#D1D5DB; margin-bottom:20px;">
                <p>¿Estás seguro de que deseas eliminar la propiedad <strong>"{{ property.title }}"</strong>?</p>
                <p style="margin-top:10px;">Esta acción no se puede deshacer y eliminará todos los datos asociados a esta propiedad.</p>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button type="button" id="cancel-delete" style="background-color:#374151; color:white; padding:10px 20px; border-radius:8px; font-weight:600; border:none; cursor:pointer;">Cancelar</button>
                <button type="submit" style="background-color:#EF4444; color:white; padding:10px 20px; border-radius:8px; font-weight:600; border:none; cursor:pointer;">Eliminar propiedad</button>
            </div>
        </div>
    </div>
</form>

<!-- WhatsApp -->
<a href="https://wa.me/{{ property.owner.phone|default:'1234567890' }}?text=Hola,%20quiero%20información%20sobre%20la%20propiedad:%20{{ property.title|urlencode }}"
    target="_blank"
    class="whatsapp-btn fixed bottom-6 right-6 w-16 h-16 flex items-center justify-center bg-[#22C55E] text-white rounded-full shadow-lg z-50">
    <i class="ri-whatsapp-line ri-2x"></i>
</a>

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/plyr@3.7.8/dist/plyr.polyfilled.min.js"></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<style>
    /* Estilos adicionales para el mapa */
    .mapboxgl-map {
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }
    .mapboxgl-ctrl-bottom-left,
    .mapboxgl-ctrl-bottom-right {
        z-index: 10;
    }
    .mapboxgl-popup {
        max-width: 300px;
    }
    .mapboxgl-popup-content {
        padding: 15px;
        border-radius: 8px;
    }
    /* Estilos para el marcador */
    .mapboxgl-marker {
        cursor: pointer;
    }
    /* Estilos para el contenedor del mapa cuando hay error */
    .map-error {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        background-color: #f3f4f6;
        color: #6b7280;
        padding: 2rem;
        text-align: center;
        border-radius: 8px;
        font-weight: 500;
    }
</style>
<script src="{% static 'js/simple-image-viewer.js' %}"></script>
<script src="{% static 'js/mapbox-detail.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar reproductor de video con Plyr
        setTimeout(function() {
            // Para videos locales
            const videoElement = document.querySelector('video#property-video');
            if (videoElement) {
                new Plyr(videoElement, {
                    controls: [
                        'play-large', 'play', 'progress', 'current-time', 'mute', 
                        'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                    ],
                    settings: ['captions', 'quality', 'speed'],
                    iconUrl: 'https://cdn.plyr.io/3.7.8/plyr.svg',
                    blankVideo: 'https://cdn.plyr.io/static/blank.mp4',
                    autoplay: false,
                    hideControls: false,
                });
            }
            
            // Para videos embebidos (YouTube/Vimeo)
            const embedElements = document.querySelectorAll('.plyr__video-embed');
            embedElements.forEach(function(element) {
                new Plyr(element, {
                    controls: [
                        'play-large', 'play', 'progress', 'current-time', 'mute', 
                        'volume', 'captions', 'settings', 'pip', 'airplay', 'fullscreen'
                    ],
                });
            });
        }, 200);
        
        // Script para el modal de eliminación
        const deleteBtn = document.getElementById('delete-property-btn');
        if (deleteBtn) {
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                document.getElementById('delete-modal').style.display = 'block';
            };
            
            document.getElementById('cancel-delete').onclick = function() {
                document.getElementById('delete-modal').style.display = 'none';
            };
        }
    });
</script>
{% endblock %}